<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–†–µ–¥–∞–∫—Ç–æ—Ä —Ç–æ–≤–∞—Ä–æ–≤ –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- Telegram WebApp JS -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #020617;
      color: #e5e7eb;
    }
    .wrap {
      padding: 12px;
      max-width: 900px;
      margin: 0 auto 24px;
    }
    .card {
      background: #020617;
      border: 1px solid #1f2937;
      border-radius: 14px;
      padding: 16px;
      box-shadow: 0 14px 45px rgba(0,0,0,0.5);
    }
    h1 {
      font-size: 18px;
      margin: 0 0 6px;
    }
    .small {
      font-size: 12px;
      color: #9ca3af;
    }
    .badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 2px 8px;
      border-radius: 999px;
      background: #111827;
      font-size: 11px;
      margin-top: 8px;
      color: #9ca3af;
    }
    .badge span {
      color: #e5e7eb;
    }
    .toolbar {
      margin-top: 12px;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
    }
    .input {
      background: #020617;
      border-radius: 999px;
      border: 1px solid #1f2937;
      padding: 6px 10px;
      font-size: 13px;
      color: #e5e7eb;
      outline: none;
      min-width: 0;
    }
    .input::placeholder {
      color: #6b7280;
    }
    .btn {
      border-radius: 999px;
      border: none;
      padding: 8px 14px;
      font-size: 13px;
      cursor: pointer;
      white-space: nowrap;
    }
    .btn-primary {
      background: #3b82f6;
      color: #f9fafb;
    }
    .btn-primary[disabled] {
      opacity: 0.4;
      cursor: default;
    }
    .btn-ghost {
      background: transparent;
      border: 1px solid #1f2937;
      color: #e5e7eb;
    }
    .btn-ghost[disabled] {
      opacity: 0.4;
      cursor: default;
    }
    .status {
      font-size: 11px;
      color: #9ca3af;
      margin-top: 6px;
    }
    .status strong {
      color: #e5e7eb;
    }
    .table-wrap {
      margin-top: 12px;
      border-radius: 10px;
      border: 1px solid #1f2937;
      overflow-y: auto;
      max-height: 70vh; /* —Å–∫—Ä–æ–ª–ª –≤–Ω—É—Ç—Ä–∏ —Ç–∞–±–ª–∏—Ü—ã */
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }
    thead {
      background: #020617;
      position: sticky;
      top: 0;
      z-index: 1;
    }
    th, td {
      padding: 6px 8px;
      border-bottom: 1px solid #111827;
    }
    th {
      text-align: left;
      font-weight: 500;
      color: #9ca3af;
      white-space: nowrap;
    }
    tbody tr:nth-child(even) {
      background: #020617;
    }
    tbody tr:nth-child(odd) {
      background: #030712;
    }
    .name-cell {
      max-width: 340px;
    }
    .name-text {
      white-space: nowrap;
      text-overflow: ellipsis;
      overflow: hidden;
    }
    .price-input {
      width: 80px;
      background: #020617;
      border: 1px solid #1f2937;
      border-radius: 999px;
      padding: 3px 8px;
      font-size: 12px;
      color: #e5e7eb;
      outline: none;
    }
    .price-input:focus {
      border-color: #3b82f6;
    }
    .tag-changed {
      display: inline-block;
      font-size: 10px;
      padding: 0 6px;
      border-radius: 999px;
      background: #1d4ed8;
      color: #e5e7eb;
      margin-left: 4px;
    }
    .empty {
      padding: 12px;
      font-size: 13px;
      color: #9ca3af;
      text-align: center;
    }
    .error {
      margin-top: 8px;
      font-size: 12px;
      color: #f97373;
      white-space: pre-wrap;
    }
    #pagination {
      margin-top: 10px;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 10px;
    }
    #page-info {
      font-size: 12px;
      color: #9ca3af;
    }
    @media (max-width: 640px) {
      .name-cell {
        max-width: 200px;
      }
      .price-input {
        width: 70px;
      }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>–†–µ–¥–∞–∫—Ç–æ—Ä —Ç–æ–≤–∞—Ä–æ–≤ –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞</h1>
      <div id="info" class="small">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</div>
      <div class="badge">
        ID –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞: <span id="supplier-badge">‚Äî</span>
      </div>

      <div class="toolbar">
        <input
          id="search"
          class="input"
          type="text"
          placeholder="–§–∏–ª—å—Ç—Ä –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é..."
        />
        <button id="btn-refresh" class="btn btn-ghost">–û–±–Ω–æ–≤–∏—Ç—å</button>
        <button id="btn-save" class="btn btn-primary" disabled>
          üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
        </button>
      </div>

      <div id="pagination">
        <button id="page-prev" class="btn btn-ghost">‚Üê</button>
        <span id="page-info">–°—Ç—Ä–∞–Ω–∏—Ü–∞ 1 –∏–∑ 1</span>
        <button id="page-next" class="btn btn-ghost">‚Üí</button>
      </div>

      <div id="status" class="status"></div>
      <div id="error" class="error" style="display:none;"></div>

      <div class="table-wrap" id="table-wrap">
        <div class="empty" id="empty-msg">–ó–¥–µ—Å—å –ø–æ—è–≤—è—Ç—Å—è —Ç–æ–≤–∞—Ä—ã –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏.</div>
        <table style="display:none;" id="table">
          <thead>
            <tr>
              <th style="width:40%;">–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ</th>
              <th>–ú–∏–Ω. —Ü–µ–Ω–∞</th>
              <th>–ú–∞–∫—Å. —Ü–µ–Ω–∞</th>
            </tr>
          </thead>
          <tbody id="tbody">
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    // ========= –ù–ê–°–¢–†–û–ô–ö–ò SUPABASE =========
    // –í–ê–ñ–ù–û: —Å—é–¥–∞ –Ω—É–∂–Ω–æ –≤—Å—Ç–∞–≤–∏—Ç—å –¢–í–û–ô URL –∏ PUBLIC ANON KEY –∏–∑ –Ω–∞—Å—Ç—Ä–æ–µ–∫ Supabase (Settings ‚Üí API).
    const SUPABASE_URL = "https://zlmtbaejzrsaarnercaz.supabase.co"; // —Ç–∞–∫–æ–π –∂–µ, –∫–∞–∫ –≤ –±–æ—Ç–µ
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpsbXRiYWVqenJzYWFybmVyY2F6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI3MjI3MTAsImV4cCI6MjA3ODI5ODcxMH0.aF9SuRPEmYpvPYFbbfl7pcCJc6MI_Acfxc6rRRrpuaM";

    // ========= Telegram WebApp =========
    const tg = window.Telegram && window.Telegram.WebApp ? window.Telegram.WebApp : null;
    if (tg) {
      tg.expand();
    }

    const params = new URLSearchParams(window.location.search);
    const supplierId = params.get("supplier_id");

    const infoEl = document.getElementById("info");
    const badgeEl = document.getElementById("supplier-badge");
    const tbody = document.getElementById("tbody");
    const table = document.getElementById("table");
    const emptyMsg = document.getElementById("empty-msg");
    const statusEl = document.getElementById("status");
    const errorEl = document.getElementById("error");
    const searchInput = document.getElementById("search");
    const btnRefresh = document.getElementById("btn-refresh");
    const btnSave = document.getElementById("btn-save");
    const pagePrev = document.getElementById("page-prev");
    const pageNext = document.getElementById("page-next");
    const pageInfo = document.getElementById("page-info");

    if (!supplierId) {
      infoEl.textContent = "‚ùå –û—à–∏–±–∫–∞: supplier_id –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω –≤ URL";
      badgeEl.textContent = "‚Äî";
    } else {
      infoEl.textContent = "WebApp —É—Å–ø–µ—à–Ω–æ –æ—Ç–∫—Ä—ã—Ç üôå";
      badgeEl.textContent = supplierId;
    }

    let allProducts = [];
    let filteredProducts = [];
    let changed = new Map(); // id -> { id, price_min, price_max }
    let pageSize = 200; // —Ç–æ–≤–∞—Ä–æ–≤ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
    let currentPage = 1;

    function setError(msg) {
      if (!msg) {
        errorEl.style.display = "none";
        errorEl.textContent = "";
      } else {
        errorEl.style.display = "block";
        errorEl.textContent = msg;
      }
    }

    function setStatus(text) {
      statusEl.innerHTML = text || "";
    }

    function setSaveButtonState() {
      const count = changed.size;
      if (count === 0) {
        btnSave.disabled = true;
        btnSave.textContent = "üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è";
      } else {
        btnSave.disabled = false;
        btnSave.textContent = `üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è (${count})`;
      }
    }

    function renderTable(data) {
      tbody.innerHTML = "";

      if (!data || data.length === 0) {
        table.style.display = "none";
        emptyMsg.style.display = "block";
        emptyMsg.textContent = "–¢–æ–≤–∞—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.";
        return;
      }

      table.style.display = "table";
      emptyMsg.style.display = "none";

      for (const row of data) {
        const tr = document.createElement("tr");

        const tdName = document.createElement("td");
        tdName.className = "name-cell";
        const nameDiv = document.createElement("div");
        nameDiv.className = "name-text";
        nameDiv.textContent = row.product_name || "(–±–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è)";
        tdName.appendChild(nameDiv);
        if (changed.has(row.id)) {
          const tag = document.createElement("span");
          tag.className = "tag-changed";
          tag.textContent = "–∏–∑–º–µ–Ω–µ–Ω–æ";
          tdName.appendChild(tag);
        }
        tr.appendChild(tdName);

        const tdMin = document.createElement("td");
        const inputMin = document.createElement("input");
        inputMin.type = "number";
        inputMin.step = "0.01";
        inputMin.className = "price-input";
        inputMin.value = row.price_min != null ? row.price_min : "";
        inputMin.addEventListener("input", () =>
          onPriceChange(row.id, "price_min", inputMin.value)
        );
        tdMin.appendChild(inputMin);
        tr.appendChild(tdMin);

        const tdMax = document.createElement("td");
        const inputMax = document.createElement("input");
        inputMax.type = "number";
        inputMax.step = "0.01";
        inputMax.className = "price-input";
        inputMax.value = row.price_max != null ? row.price_max : "";
        inputMax.addEventListener("input", () =>
          onPriceChange(row.id, "price_max", inputMax.value)
        );
        tdMax.appendChild(inputMax);
        tr.appendChild(tdMax);

        tbody.appendChild(tr);
      }
    }

    function renderPagination() {
      const total = filteredProducts.length;
      const pageCount = total === 0 ? 1 : Math.ceil(total / pageSize);

      if (currentPage > pageCount) currentPage = pageCount;
      if (currentPage < 1) currentPage = 1;

      pageInfo.textContent = total === 0
        ? "–°—Ç—Ä–∞–Ω–∏—Ü–∞ 0 –∏–∑ 0"
        : `–°—Ç—Ä–∞–Ω–∏—Ü–∞ ${currentPage} –∏–∑ ${pageCount}`;

      pagePrev.disabled = currentPage <= 1 || total === 0;
      pageNext.disabled = currentPage >= pageCount || total === 0;
    }

    function renderCurrentPage() {
      const total = filteredProducts.length;

      if (total === 0) {
        renderTable([]);
        renderPagination();
        setStatus("–ù–µ—Ç —Ç–æ–≤–∞—Ä–æ–≤ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è.");
        return;
      }

      const pageCount = Math.ceil(total / pageSize);
      if (currentPage > pageCount) currentPage = pageCount;
      if (currentPage < 1) currentPage = 1;

      const start = (currentPage - 1) * pageSize;
      const end = start + pageSize;
      const pageData = filteredProducts.slice(start, end);

      renderTable(pageData);
      renderPagination();
      setStatus(
        `–ü–æ–∫–∞–∑–∞–Ω–æ <strong>${pageData.length}</strong> –∏–∑ ${filteredProducts.length} (–≤—Å–µ–≥–æ –≤ –±–∞–∑–µ: ${allProducts.length})`
      );
    }

    function applyFilter() {
      const q = (searchInput.value || "").toLowerCase().trim();
      if (!q) {
        filteredProducts = allProducts.slice();
      } else {
        filteredProducts = allProducts.filter((p) =>
          (p.product_name || "").toLowerCase().includes(q)
        );
      }
      currentPage = 1;
      renderCurrentPage();
    }

    function onPriceChange(id, field, value) {
      const num = value === "" ? null : Number(String(value).replace(",", "."));
      const idx = allProducts.findIndex((p) => p.id === id);
      if (idx === -1) return;

      allProducts[idx][field] = num;

      const current =
        changed.get(id) || {
          id,
          price_min: allProducts[idx].price_min,
          price_max: allProducts[idx].price_max,
        };
      current[field] = num;
      changed.set(id, current);

      setSaveButtonState();
      renderCurrentPage();
    }

    async function loadProducts() {
      if (!supplierId) return;

      setError("");
      setStatus("–ó–∞–≥—Ä—É–∂–∞—é —Ç–æ–≤–∞—Ä—ã...");
      btnRefresh.disabled = true;

      try {
        const url =
          `${SUPABASE_URL}/rest/v1/products` +
          `?select=id,product_name,price_min,price_max` +
          `&supplier_id=eq.${encodeURIComponent(supplierId)}` +
          `&order=product_name.asc` +
          `&limit=5000`; // –∑–∞–ø–∞—Å –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É

        const res = await fetch(url, {
          headers: {
            apikey: SUPABASE_ANON_KEY,
            Authorization: `Bearer ${SUPABASE_ANON_KEY}`,
          },
        });

        if (!res.ok) {
          const text = await res.text();
          throw new Error(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ (${res.status}): ${text}`);
        }

        const data = await res.json();
        allProducts = data;
        changed.clear();
        setSaveButtonState();

        if (data.length === 0) {
          setStatus("–î–ª—è —ç—Ç–æ–≥–æ –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞ –ø–æ–∫–∞ –Ω–µ—Ç —Ç–æ–≤–∞—Ä–æ–≤.");
        }

        applyFilter();
      } catch (err) {
        console.error(err);
        setError(String(err.message || err));
        setStatus("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ç–æ–≤–∞—Ä—ã.");
      } finally {
        btnRefresh.disabled = false;
      }
    }

    async function saveChanges() {
      if (changed.size === 0) return;
      setError("");
      btnSave.disabled = true;
      btnSave.textContent = "–°–æ—Ö—Ä–∞–Ω—è—é...";

      try {
        const items = Array.from(changed.values());

        for (const item of items) {
          const url = `${SUPABASE_URL}/rest/v1/products?id=eq.${item.id}`;
          const body = {
            price_min: item.price_min,
            price_max: item.price_max,
          };

          const res = await fetch(url, {
            method: "PATCH",
            headers: {
              apikey: SUPABASE_ANON_KEY,
              Authorization: `Bearer ${SUPABASE_ANON_KEY}`,
              "Content-Type": "application/json",
              Prefer: "return=representation",
            },
            body: JSON.stringify(body),
          });

          if (!res.ok) {
            const text = await res.text();
            throw new Error(
              `–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–∞ ${item.id} (${res.status}): ${text}`
            );
          }
        }

        changed.clear();
        setSaveButtonState();
        setStatus(`–ò–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã. –û–±–Ω–æ–≤–ª—è—é —Å–ø–∏—Å–æ–∫...`);
        await loadProducts();
      } catch (err) {
        console.error(err);
        setError(String(err.message || err));
        setStatus("–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏.");
      } finally {
        setSaveButtonState();
      }
    }

    // ========= –°–æ–±—ã—Ç–∏—è =========
    searchInput.addEventListener("input", () => {
      applyFilter();
    });

    btnRefresh.addEventListener("click", () => {
      loadProducts();
    });

    btnSave.addEventListener("click", () => {
      if (changed.size > 0) {
        saveChanges();
      }
    });

    pagePrev.addEventListener("click", () => {
      if (currentPage > 1) {
        currentPage--;
        renderCurrentPage();
      }
    });

    pageNext.addEventListener("click", () => {
      const total = filteredProducts.length;
      const pageCount = Math.ceil(total / pageSize);
      if (currentPage < pageCount) {
        currentPage++;
        renderCurrentPage();
      }
    });

    // ========= –°—Ç–∞—Ä—Ç =========
    if (!supplierId) {
      setStatus("–ù–µ—Ç supplier_id ‚Äî —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ.");
    } else if (
      !SUPABASE_ANON_KEY ||
      SUPABASE_ANON_KEY.startsWith("–í–°–¢–ê–í–¨_")
    ) {
      setStatus("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ SUPABASE_ANON_KEY –≤ index.html");
      setError("–í –∫–æ–¥–µ WebApp –Ω—É–∂–Ω–æ —É–∫–∞–∑–∞—Ç—å –≤–∞—à PUBLIC ANON KEY Supabase.");
    } else {
      loadProducts();
    }
  </script>
</body>
</html>
