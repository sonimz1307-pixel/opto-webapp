<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–ü—Ä–æ—Ñ–∏–ª—å –æ–ø—Ç–æ–≤–∏–∫–∞ ‚Äî OptoVizor</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://telegram.org/js/telegram-web-app.js?1"></script>

  <style>
    * { box-sizing: border-box; }

    :root {
      --bg: #020617;
      --text: #e5e7eb;
      --muted: #9ca3af;
      --accent: #38bdf8;
      --card-radius: 20px;
      --shadow-soft: 0 18px 45px rgba(0,0,0,0.35);
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #0b1120 0, #020617 40%);
      color: var(--text);
      min-height: 100vh;
    }

    .wrap {
      min-height: 100vh;
      padding: 18px 16px 28px;
      display: flex;
      flex-direction: column;
      gap: 14px;
    }

    /* HEADER */
    .header { display: flex; align-items: center; justify-content: space-between; gap: 8px; }
    .title-block { display: flex; flex-direction: column; gap: 4px; }
    .title { font-size: 18px; font-weight: 600; }
    .subtitle { font-size: 12px; color: var(--muted); }

    .pill {
      font-size: 11px;
      border-radius: 999px;
      padding: 4px 10px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(148, 163, 184, 0.18);
      color: var(--muted);
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }
    .pill-dot {
      width: 7px; height: 7px; border-radius: 50%; background: #22c55e;
      box-shadow: 0 0 0 4px rgba(34, 197, 94, 0.2);
    }

    /* CARDS */
    .cards-grid { display: flex; flex-direction: column; gap: 12px; margin-top: 4px; }

    .card {
      background: radial-gradient(circle at top left, rgba(56,189,248,0.12) 0, rgba(15,23,42,0.96) 38%, #020617 75%);
      border-radius: var(--card-radius);
      border: 1px solid rgba(148,163,184,0.16);
      box-shadow: var(--shadow-soft);
      padding: 14px;
    }

    .card-header {
      display: flex; justify-content: space-between; align-items: center;
      margin-bottom: 10px;
    }

    .card-title { font-size: 14px; font-weight: 600; }
    .card-sub { font-size: 11px; color: var(--muted); }

    .badge {
      font-size: 11px; padding: 4px 8px; border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.3);
      background: rgba(15,23,42,0.9); color: var(--muted);
      display: inline-flex; align-items: center; gap: 5px;
    }

    .status-dot-ok { width: 7px; height: 7px; border-radius: 50%; background: #22c55e; }
    .status-dot-neutral { width: 7px; height: 7px; border-radius: 50%; background: #6b7280; }
    .status-dot-loading {
      width: 7px; height: 7px; border-radius: 50%;
      border: 2px solid var(--accent); border-top-color: transparent;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin { to { transform: rotate(360deg); } }

    /* INPUTS */
    .form-grid { display: flex; flex-direction: column; gap: 8px; }
    .field { display: flex; flex-direction: column; gap: 4px; }
    .label { font-size: 11px; color: var(--muted); }

    .input {
      font-size: 13px; padding: 8px 10px; border-radius: 10px;
      border: 1px solid rgba(148,163,184,0.35);
      background: rgba(15,23,42,0.95); color: var(--text);
    }
    .input:focus { border-color: var(--accent); box-shadow: 0 0 0 1px rgba(56,189,248,0.6); }

    /* CHIPS */
    .chips-row { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 6px; }
    .chip {
      font-size: 11px; padding: 4px 8px; border-radius: 999px;
      background: rgba(15,23,42,0.9);
      border: 1px dashed rgba(148,163,184,0.4); color: var(--muted);
    }

    /* BUTTONS */
    .btn-row { display: flex; gap: 8px; margin-top: 10px; }
    .btn {
      flex: 1; padding: 9px 12px; border-radius: 999px; cursor: pointer;
      display: inline-flex; align-items: center; justify-content: center; gap: 8px;
      font-size: 13px; transition: 0.15s ease;
      border: none;
    }

    .btn-primary {
      background: linear-gradient(135deg, #0ea5e9, #22c55e); color: #fff;
      box-shadow: 0 12px 30px rgba(34,197,94,0.35);
    }
    .btn-primary:active { transform: scale(0.98); }

    .btn-soft {
      background: rgba(15,23,42,0.9); color: var(--muted);
      border: 1px solid rgba(148,163,184,0.35);
    }
    .btn-soft:active { transform: scale(0.98); }

    .btn:disabled { opacity: 0.6; cursor: default; }

    /* STATUS LINE */
    .status-line {
      margin-top: 8px; font-size: 11px; color: var(--muted);
      display: flex; align-items: center; gap: 6px;
      min-height: 16px;
    }

    /* ACCORDION */
    .accordion {
      border-radius: 16px; border: 1px solid rgba(148,163,184,0.22);
      background: rgba(15,23,42,0.7); overflow: hidden; margin-top: 12px;
    }
    .accordion-header {
      padding: 14px 16px; font-size: 14px;
      display: flex; justify-content: space-between; align-items: center;
      cursor: pointer; user-select: none;
    }
    .accordion-body { display: none; }
    .accordion.open .accordion-body { display: block; }
    .acc-arrow { transition: transform 0.3s; }
    .accordion.open .acc-arrow { transform: rotate(180deg); }

    /* STEPS */
    .steps {
      margin-top: 8px; padding: 8px 10px; border-radius: 12px;
      background: rgba(15,23,42,0.95); border: 1px dashed rgba(148,163,184,0.45);
      font-size: 11px; color: var(--muted);
    }
    .steps-title { font-size: 12px; font-weight: 500; color: #fff; margin-bottom: 4px; }

    /* LINKS */
    .link-btn {
      margin-top: 12px; padding: 7px 12px; border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.5); font-size: 12px;
      color: var(--text); background: rgba(15,23,42,0.95);
      text-decoration: none; text-align: center;
      display: inline-flex; align-items: center; gap: 6px;
    }

    @media (min-width: 768px) {
      .wrap { max-width: 520px; margin: 0 auto; }
    }
  </style>
</head>
<body>
  <div class="wrap">

    <!-- ============================
         HEADER
    ============================ -->
    <div class="header">
      <div class="title-block">
        <div class="title">–ü—Ä–æ—Ñ–∏–ª—å –æ–ø—Ç–æ–≤–∏–∫–∞</div>
        <div class="subtitle" id="subtitle">–ó–∞–≥—Ä—É–∂–∞—é –¥–∞–Ω–Ω—ã–µ –ø—Ä–æ—Ñ–∏–ª—è...</div>
      </div>

      <div class="pill">
        <span class="pill-dot"></span>
        —á–µ—Ä–µ–∑ Telegram-–±–æ—Ç–∞
      </div>
    </div>


    <!-- ======================================================
         –ö–ê–†–¢–û–ß–ö–ò (–æ—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–ø—Ç–æ–≤–∏–∫–∞)
    ====================================================== -->

    <div class="cards-grid">

      <section class="card" id="card-profile">
        <div class="card-header">
          <div>
            <div class="card-title">–û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</div>
            <div class="card-sub">–≠—Ç–∏ –¥–∞–Ω–Ω—ã–µ –≤–∏–¥—è—Ç –∫–ª–∏–µ–Ω—Ç—ã –≤ –∫–∞—Ä—Ç–æ—á–∫–µ –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞</div>
          </div>

          <div class="badge" id="badge-verified">
            <span id="badge-verified-dot" class="status-dot-neutral"></span>
            <span id="badge-verified-text">–û–∂–∏–¥–∞–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è</span>
          </div>
        </div>

        <div class="form-grid">
          <div class="field">
            <div class="label">–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏</div>
            <input id="fld-name" class="input" placeholder="–û–û–û ¬´–ö–æ–º–ø–∞–Ω–∏—è¬ª" />
          </div>

          <div class="field">
            <div class="label">–ì–æ—Ä–æ–¥</div>
            <input id="fld-city" class="input" placeholder="–ú–æ—Å–∫–≤–∞" />
          </div>

          <div class="field">
            <div class="label">–ö–∞—Ç–µ–≥–æ—Ä–∏—è —Ç–æ–≤–∞—Ä–∞</div>
            <input id="fld-category" class="input" placeholder="Vape, –∫–æ—Å–º–µ—Ç–∏–∫–∞, —Å–ø–æ—Ä—Ç–ø–∏—Ç..." />
          </div>

          <div class="field">
            <div class="label">–¢–µ–ª–µ—Ñ–æ–Ω</div>
            <input id="fld-phone" class="input" placeholder="+7..." />
          </div>

          <div class="field">
            <div class="label">Telegram –¥–ª—è —Å–≤—è–∑–∏</div>
            <input id="fld-telegram" class="input" placeholder="@username" />
          </div>

          <div class="field">
            <div class="label">–°–∞–π—Ç / —Å—Å—ã–ª–∫–∞</div>
            <input id="fld-site" class="input" placeholder="https://..." />
          </div>

          <div class="chips-row" id="chips-row">
            <div class="chip" id="chip-chz">–ß–ó / –≠–î–û: –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div>
            <div class="chip" id="chip-id">ID –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞: ‚Äî</div>
          </div>
        </div>

        <div class="btn-row">
          <button class="btn btn-soft" id="btn-cancel">–û—Ç–º–µ–Ω–∞</button>
          <button class="btn btn-primary" id="btn-save">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</button>
        </div>

        <div class="status-line" id="status-profile">
          <span class="status-dot-neutral"></span>
          <span>–ò–∑–º–µ–Ω–µ–Ω–∏—è –ø–æ–∫–∞ –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–ª–∏—Å—å.</span>
        </div>

        <div class="btn-row" style="margin-top:10px;">
          <a href="https://sonimz1307-pixel.github.io/optovizor-moysklad-instruction/company.html" 
             target="_blank"
             class="btn btn-soft" style="text-align:center;">üåê –°–∞–π—Ç OptoVizor</a>

          <a href="https://t.me/opto_placeholder"
             target="_blank"
             class="btn btn-soft"
             style="text-align:center;">üí¨ Telegram-—Å–æ–æ–±—â–µ—Å—Ç–≤–æ</a>
        </div>
      </section>



      <!-- ======================================================
           –ú –û –ô –° –ö –õ –ê –î ‚Äî –ù –û –í –ê –Ø  –ò –ù –¢ –ï –ì –† –ê –¶ –ò –Ø
      ====================================================== -->

      <div class="accordion" id="acc-ms">
        <div class="accordion-header">
          <span>–ú–æ–π–°–∫–ª–∞–¥ ‚Äî –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è (–Ω–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞)</span>
          <span class="acc-arrow">‚ñº</span>
        </div>

        <div class="accordion-body">
          <section class="card" id="card-ms">

            <div class="card-header">
              <div>
                <div class="card-title">–ü—Ä–∏–≤—è–∑–∫–∞ –∞–∫–∫–∞—É–Ω—Ç–∞ –ú–æ–π–°–∫–ª–∞–¥</div>
                <div class="card-sub">–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ç–æ–∫–µ–Ω –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è</div>
              </div>
              <div class="badge">
                <span id="ms-badge-dot" class="status-dot-neutral"></span>
                <span id="ms-badge-text">–ù–µ –ø—Ä–∏–≤—è–∑–∞–Ω</span>
              </div>
            </div>


            <!-- TOKEN BLOCK -->
            <div class="form-grid">
              <div class="field">
                <div class="label">–í–∞—à –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π —Ç–æ–∫–µ–Ω OptoVizor (—É–∫–∞–∂–∏—Ç–µ –µ–≥–æ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –ú–æ–π–°–∫–ª–∞–¥)</div>
                <input id="ms-token" class="input" readonly placeholder="–¢–æ–∫–µ–Ω –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è..." />
              </div>

              <div class="btn-row">
                <button class="btn btn-soft" id="ms-copy">üìã –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–∫–µ–Ω</button>
              </div>
            </div>


            <!-- INSTRUCTIONS -->
            <div class="form-grid" style="margin-top:12px;">
              <div class="label">–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è</div>

              <div class="steps">
                <div class="steps-title">–ö–∞–∫ –ø–æ–¥–∫–ª—é—á–∏—Ç—å –ú–æ–π–°–∫–ª–∞–¥:</div>
                <ol>
                  <li>–û—Ç–∫—Ä–æ–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ OptoVizor –≤ –ú–æ–π–°–∫–ª–∞–¥.</li>
                  <li>–í–≤–µ–¥–∏—Ç–µ —Ç—É–¥–∞ —ç—Ç–æ—Ç —Ç–æ–∫–µ–Ω.</li>
                  <li>–ù–∞–∂–º–∏—Ç–µ ¬´–ü—Ä–∏–≤—è–∑–∞—Ç—å¬ª –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏.</li>
                  <li>–í–µ—Ä–Ω–∏—Ç–µ—Å—å —Å—é–¥–∞ –∏ –Ω–∞–∂–º–∏—Ç–µ ¬´–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–∏–≤—è–∑–∫—É¬ª.</li>
                </ol>
              </div>
            </div>


            <!-- BUTTON CHECK -->
            <div class="btn-row" style="margin-top:12px;">
              <button class="btn btn-primary" id="ms-check">üîç –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–∏–≤—è–∑–∫—É</button>
            </div>

            <a href="https://online.moysklad.ru/"
               target="_blank"
               class="link-btn">
              üåê –û—Ç–∫—Ä—ã—Ç—å –ú–æ–π–°–∫–ª–∞–¥
            </a>

            <div class="status-line" id="ms-status">
              <span class="status-dot-neutral"></span>
              <span>–û–∂–∏–¥–∞–µ—Ç –ø—Ä–∏–≤—è–∑–∫–∏...</span>
            </div>

          </section>
        </div>
      </div>



      <!-- ======================================================
           1–° ‚Äî –±–ª–æ–∫ –ø—Ä–æ—Å—Ç–æ –æ—Å—Ç–∞–≤–ª—è–µ–º –∫–∞–∫ –µ—Å—Ç—å
      ====================================================== -->

      <div class="accordion" id="acc-1c">
        <div class="accordion-header">
          <span>1–° ‚Äî –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è</span>
          <span class="acc-arrow">‚ñº</span>
        </div>

        <div class="accordion-body">
          <section class="card">
            <div class="card-header">
              <div>
                <div class="card-title">1–° ‚Äî –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è (—Å–∫–æ—Ä–æ)</div>
                <div class="card-sub">–ò–¥—ë—Ç —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞ –º–æ–¥—É–ª—è –¥–ª—è –æ–±–º–µ–Ω–∞ —Ç–æ–≤–∞—Ä–∞–º–∏ –∏ –æ—Å—Ç–∞—Ç–∫–∞–º–∏.</div>
              </div>
            </div>

            <div class="form-grid">
              <div class="field">
                <div class="label">–°—Ç–∞—Ç—É—Å</div>
                <div class="status-line">
                  <span class="status-dot-neutral"></span>
                  <span>–ú–æ–¥—É–ª—å –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ.</span>
                </div>
              </div>
            </div>
          </section>
        </div>
      </div>

    </div> <!-- cards-grid -->

  </div> <!-- wrap -->
<script>
/* ============================
   –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø WEBAPP
============================ */
const tg = window.Telegram && window.Telegram.WebApp;
if (tg) {
  setTimeout(() => {
    tg.ready();
    tg.expand();
  }, 150);
}

/* ============================
   –≠–õ–ï–ú–ï–ù–¢–´ –ü–†–û–§–ò–õ–Ø
============================ */
const fldName     = document.getElementById('fld-name');
const fldCity     = document.getElementById('fld-city');
const fldCategory = document.getElementById('fld-category');
const fldPhone    = document.getElementById('fld-phone');
const fldTelegram = document.getElementById('fld-telegram');
const fldSite     = document.getElementById('fld-site');

const chipChz  = document.getElementById('chip-chz');
const chipId   = document.getElementById('chip-id');

const badgeVerifiedDot  = document.getElementById('badge-verified-dot');
const badgeVerifiedText = document.getElementById('badge-verified-text');

const subtitle = document.getElementById('subtitle');

const statusProfile = document.getElementById('status-profile');

const btnSave   = document.getElementById('btn-save');
const btnCancel = document.getElementById('btn-cancel');

let originalProfile = null;


/* =====================================================
   –ó–ê–ì–†–£–ó–ö–ê –ü–†–û–§–ò–õ–Ø (–ü–†–ò–•–û–î–ò–¢ –ß–ï–†–ï–ó tg.sendData ‚Üí data)
===================================================== */
function loadProfileFromQuery() {
  try {
    const url = new URL(window.location.href);
    const dataStr = url.searchParams.get('data');

    if (!dataStr) {
      subtitle.textContent = '–î–∞–Ω–Ω—ã–µ –ø—Ä–æ—Ñ–∏–ª—è –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω—ã. –û—Ç–∫—Ä–æ–π—Ç–µ —ç—Ç–æ—Ç —ç–∫—Ä–∞–Ω –∏–∑ –±–æ—Ç–∞.';
      return;
    }

    const decoded = decodeURIComponent(dataStr);
    const obj = JSON.parse(decoded);

    originalProfile = obj;
    window.profileData = obj;

    fldName.value     = obj.name || '';
    fldCity.value     = obj.city || '';
    fldCategory.value = obj.category || '';
    fldPhone.value    = obj.phone || '';
    fldTelegram.value = obj.telegram || '';
    fldSite.value     = obj.site || '';

    const chz = !!obj.is_chz;
    chipChz.textContent = '–ß–ó / –≠–î–û: ' + (chz ? '–î–∞' : '–ù–µ—Ç');
    chipChz.style.borderStyle = chz ? 'solid' : 'dashed';

    const idVal = obj.id != null ? String(obj.id) : '‚Äî';
    chipId.textContent = 'ID –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞: ' + idVal;
    subtitle.textContent = `ID: ${idVal}`;

    // –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è
    if (obj.is_verified) {
      badgeVerifiedDot.className = 'status-dot-ok';
      badgeVerifiedText.textContent = '–ü–æ—Å—Ç–∞–≤—â–∏–∫ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω';
    } else {
      badgeVerifiedDot.className = 'status-dot-neutral';
      badgeVerifiedText.textContent = '–û–∂–∏–¥–∞–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è';
    }

    // –°–æ—Å—Ç–æ—è–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞ (–ø–µ—Ä–≤–∏—á–Ω–æ–µ)
    updateMsToken();

  } catch (e) {
    console.error('–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è:', e);
    subtitle.textContent = '–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –ø—Ä–æ—Ñ–∏–ª—è.';
  }
}

loadProfileFromQuery();



/* ============================
   –°–û–•–†–ê–ù–ï–ù–ò–ï –ü–†–û–§–ò–õ–Ø
============================ */
function setProfileStatus(type, text) {
  const dot = statusProfile.querySelector('span');
  const msg = statusProfile.querySelectorAll('span')[1];

  dot.className = '';
  if (type === 'loading')      dot.classList.add('status-dot-loading');
  else if (type === 'ok')      dot.classList.add('status-dot-ok');
  else                         dot.classList.add('status-dot-neutral');

  msg.textContent = text;
}

btnSave.addEventListener('click', () => {
  if (!tg) return alert('–û—Ç–∫—Ä–æ–π—Ç–µ —ç–∫—Ä–∞–Ω –∏–∑ Telegram-–±–æ—Ç–∞.');

  const payload = {
    action: 'save_supplier_profile',
    name: fldName.value.trim(),
    city: fldCity.value.trim(),
    category: fldCategory.value.trim(),
    phone: fldPhone.value.trim(),
    telegram: fldTelegram.value.trim(),
    site: fldSite.value.trim(),
    token: window.profileData.token
  };

  setProfileStatus('loading', '–û—Ç–ø—Ä–∞–≤–ª—è—é –∏–∑–º–µ–Ω–µ–Ω–∏—è...');

  try {
    tg.sendData(JSON.stringify(payload));
    setTimeout(() => {
      setProfileStatus('ok', '–ò–∑–º–µ–Ω–µ–Ω–∏—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã ‚Äî –ø—Ä–æ–≤–µ—Ä—å—Ç–µ —á–∞—Ç.');
    }, 600);
  } catch (e) {
    console.error(e);
    setProfileStatus('neutral', '–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏.');
  }
});

btnCancel.addEventListener('click', () => {
  if (!originalProfile) return;

  fldName.value     = originalProfile.name || '';
  fldCity.value     = originalProfile.city || '';
  fldCategory.value = originalProfile.category || '';
  fldPhone.value    = originalProfile.phone || '';
  fldTelegram.value = originalProfile.telegram || '';
  fldSite.value     = originalProfile.site || '';

  setProfileStatus('neutral', '–ò–∑–º–µ–Ω–µ–Ω–∏—è —Å–±—Ä–æ—à–µ–Ω—ã.');
});



/* =====================================================
   –ù–û–í–ê–Ø –ò–ù–¢–ï–ì–†–ê–¶–ò–Ø –ú–û–ô–°–ö–õ–ê–î ‚Äî –ß–ï–†–ï–ó –¢–û–ö–ï–ù
===================================================== */

const msTokenInput = document.getElementById('ms-token');
const msBadgeDot   = document.getElementById('ms-badge-dot');
const msBadgeText  = document.getElementById('ms-badge-text');
const msStatus     = document.getElementById('ms-status');

const msCopyBtn    = document.getElementById('ms-copy');
const msCheckBtn   = document.getElementById('ms-check');

function setMsStatus(type, text) {
  const dot = msStatus.querySelector('span');
  const msg = msStatus.querySelectorAll('span')[1];

  dot.className = '';
  if (type === 'loading') dot.classList.add('status-dot-loading');
  else if (type === 'ok') dot.classList.add('status-dot-ok');
  else if (type === 'error') dot.classList.add('status-dot-neutral');
  else dot.classList.add('status-dot-neutral');

  msg.textContent = text;
}


function updateMsBadge(linked, accountId) {
  if (linked) {
    msBadgeDot.className = 'status-dot-ok';
    msBadgeText.textContent =
      accountId ? `–ü—Ä–∏–≤—è–∑–∞–Ω (‚Ä¶${String(accountId).slice(-6)})` : '–ü—Ä–∏–≤—è–∑–∞–Ω';
  } else {
    msBadgeDot.className = 'status-dot-neutral';
    msBadgeText.textContent = '–ù–µ –ø—Ä–∏–≤—è–∑–∞–Ω';
  }
}


function updateMsToken() {
  const data = window.profileData || {};
  const token = data.token || '';

  if (!token) {
    msTokenInput.value = '–¢–æ–∫–µ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω';
    setMsStatus('neutral', '–¢–æ–∫–µ–Ω –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç.');
    updateMsBadge(false, null);
    return;
  }

  msTokenInput.value = token;

  if (data.moy_linked) {
    setMsStatus('ok', '–ú–æ–π–°–∫–ª–∞–¥ –ø—Ä–∏–≤—è–∑–∞–Ω.');
  } else {
    setMsStatus('neutral', '–û–∂–∏–¥–∞–µ—Ç –ø—Ä–∏–≤—è–∑–∫–∏...');
  }

  updateMsBadge(data.moy_linked, data.moy_account_id);
}


msCopyBtn.addEventListener('click', () => {
  const token = msTokenInput.value.trim();
  if (!token || token === '–¢–æ–∫–µ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω') return;
  navigator.clipboard.writeText(token);
  alert('–¢–æ–∫–µ–Ω —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω!');
});


msCheckBtn.addEventListener('click', () => {
  if (!tg) return alert('–û—Ç–∫—Ä–æ–π—Ç–µ —ç–∫—Ä–∞–Ω –∏–∑ Telegram-–±–æ—Ç–∞.');

  setMsStatus('loading', '–ü—Ä–æ–≤–µ—Ä—è—é –ø—Ä–∏–≤—è–∑–∫—É‚Ä¶');

  try {
    tg.sendData(JSON.stringify({
      action: "check_moysklad_link"
    }));

    setTimeout(() => {
      setMsStatus('ok', '–ó–∞–ø—Ä–æ—Å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á–∞—Ç —Å –±–æ—Ç–æ–º.');
    }, 700);

  } catch (e) {
    console.error(e);
    setMsStatus('error', '–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏.');
  }
});



/* ============================
   –ê–ö–ö–û–†–î–ò–û–ù–´
============================ */
document.querySelectorAll('.accordion-header').forEach(h => {
  h.addEventListener('click', () => {
    h.parentElement.classList.toggle('open');
  });
});
</script>
