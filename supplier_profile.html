<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–ü—Ä–æ—Ñ–∏–ª—å –æ–ø—Ç–æ–≤–∏–∫–∞ ‚Äî OptoVizor</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    * {
      box-sizing: border-box;
    }
    :root {
      --bg: #020617;
      --bg-elevated: #020617;
      --text: #e5e7eb;
      --muted: #9ca3af;
      --accent: #38bdf8;
      --accent-soft: rgba(56, 189, 248, 0.1);
      --danger: #f97373;
      --border: #1f2937;
      --card-radius: 20px;
      --input-bg: #020617;
      --shadow-soft: 0 18px 45px rgba(0,0,0,0.35);
    }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #0b1120 0, #020617 40%);
      color: var(--text);
      min-height: 100vh;
    }
    .wrap {
      min-height: 100vh;
      padding: 18px 16px 28px;
      display: flex;
      flex-direction: column;
      gap: 14px;
    }
    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }
    .title-block {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .title {
      font-size: 18px;
      font-weight: 600;
      letter-spacing: 0.02em;
    }
    .subtitle {
      font-size: 12px;
      color: var(--muted);
    }
    .pill {
      font-size: 11px;
      border-radius: 999px;
      padding: 4px 10px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(148, 163, 184, 0.18);
      color: var(--muted);
      display: inline-flex;
      align-items: center;
      gap: 4px;
      white-space: nowrap;
    }
    .pill-dot {
      width: 7px;
      height: 7px;
      border-radius: 50%;
      background: #22c55e;
      box-shadow: 0 0 0 4px rgba(34, 197, 94, 0.2);
    }

    .cards-grid {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-top: 4px;
    }
    .card {
      background: radial-gradient(circle at top left, rgba(56,189,248,0.12) 0, rgba(15,23,42,0.96) 38%, #020617 75%);
      border-radius: var(--card-radius);
      border: 1px solid rgba(148, 163, 184, 0.16);
      box-shadow: var(--shadow-soft);
      padding: 14px 14px 14px;
    }
    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin-bottom: 10px;
    }
    .card-title {
      font-size: 14px;
      font-weight: 600;
    }
    .card-sub {
      font-size: 11px;
      color: var(--muted);
    }
    .badge {
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.3);
      background: rgba(15,23,42,0.9);
      color: var(--muted);
      display: inline-flex;
      align-items: center;
      gap: 5px;
      white-space: nowrap;
    }
    .badge-dot-ok {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: #22c55e;
    }
    .badge-dot-warn {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: #fbbf24;
    }

    .form-grid {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .field {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .label {
      font-size: 11px;
      color: var(--muted);
    }
    .input {
      font-size: 13px;
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid rgba(148,163,184,0.35);
      background: rgba(15,23,42,0.95);
      color: var(--text);
      outline: none;
    }
    .input:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(56,189,248,0.6);
    }
    .input::placeholder {
      color: #6b7280;
    }

    .chips-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 6px;
    }
    .chip {
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 999px;
      background: rgba(15,23,42,0.9);
      border: 1px dashed rgba(148,163,184,0.4);
      color: var(--muted);
    }

    .btn-row {
      display: flex;
      gap: 8px;
      margin-top: 10px;
    }
    .btn {
      flex: 1;
      font-size: 13px;
      border-radius: 999px;
      padding: 9px 12px;
      border: none;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: transform 0.1s ease, box-shadow 0.1s ease, background 0.2s ease, opacity 0.2s ease;
      white-space: nowrap;
    }
    .btn-primary {
      background: linear-gradient(135deg, #0ea5e9, #22c55e);
      color: white;
      box-shadow: 0 12px 30px rgba(34,197,94,0.35);
    }
    .btn-primary:active {
      transform: translateY(1px) scale(0.99);
      box-shadow: 0 7px 18px rgba(34,197,94,0.45);
    }
    .btn-soft {
      background: rgba(15,23,42,0.9);
      color: var(--muted);
      border: 1px solid rgba(148,163,184,0.35);
      box-shadow: 0 10px 28px rgba(15,23,42,0.9);
    }
    .btn-soft:active {
      transform: translateY(1px) scale(0.99);
      box-shadow: 0 6px 16px rgba(15,23,42,0.9);
    }
    .btn:disabled {
      opacity: 0.65;
      cursor: default;
      transform: none;
      box-shadow: none;
    }

    .status-line {
      margin-top: 8px;
      font-size: 11px;
      color: var(--muted);
      display: flex;
      align-items: center;
      gap: 6px;
      min-height: 16px;
      white-space: pre-line;
    }
    .status-dot-loading {
      width: 7px;
      height: 7px;
      border-radius: 50%;
      border: 2px solid var(--accent);
      border-top-color: transparent;
      animation: spin 0.8s linear infinite;
    }
    .status-dot-ok {
      width: 7px;
      height: 7px;
      border-radius: 50%;
      background: #22c55e;
    }
    .status-dot-neutral {
      width: 7px;
      height: 7px;
      border-radius: 50%;
      background: #6b7280;
    }

    .steps {
      margin-top: 8px;
      padding: 8px 10px;
      border-radius: 12px;
      background: rgba(15,23,42,0.95);
      border: 1px dashed rgba(148,163,184,0.45);
      font-size: 11px;
      color: var(--muted);
    }
    .steps-title {
      font-weight: 500;
      margin-bottom: 4px;
      color: #e5e7eb;
      font-size: 12px;
    }
    .steps ol {
      padding-left: 16px;
      margin: 0;
    }
    .steps li {
      margin-bottom: 3px;
    }

    .link-btn {
      margin-top: 8px;
      font-size: 12px;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 7px 12px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.5);
      color: var(--text);
      background: rgba(15,23,42,0.95);
    }

    .footer-hint {
      margin-top: 6px;
      font-size: 10px;
      color: var(--muted);
      text-align: center;
      opacity: 0.85;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    @media (min-width: 768px) {
      .wrap {
        max-width: 520px;
        margin: 0 auto;
      }
    }
  
/* ACCORDION */
.accordion {border-radius:16px;border:1px solid rgba(148,163,184,0.22);background:rgba(15,23,42,0.7);overflow:hidden;margin-top:12px;}
.accordion-header {padding:14px 16px;font-size:14px;display:flex;justify-content:space-between;align-items:center;cursor:pointer;user-select:none;}
.accordion-body {display:none;}
.accordion.open .accordion-body {display:block;}
.acc-arrow {transition:transform 0.3s;}
.accordion.open .acc-arrow {transform:rotate(180deg);}

</style>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <div class="title-block">
        <div class="title">–ü—Ä–æ—Ñ–∏–ª—å –æ–ø—Ç–æ–≤–∏–∫–∞</div>
        <div class="subtitle" id="subtitle">
          –ó–∞–≥—Ä—É–∂–∞—é –¥–∞–Ω–Ω—ã–µ –ø—Ä–æ—Ñ–∏–ª—è...
        </div>
      </div>
      <div class="pill">
        <span class="pill-dot"></span>
        —á–µ—Ä–µ–∑ Telegram-–±–æ—Ç–∞
      </div>
    </div>

    <div class="cards-grid">

      <section class="card" id="card-profile">
        <div class="card-header">
          <div>
            <div class="card-title">–û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</div>
            <div class="card-sub">–î–∞–Ω–Ω—ã–µ –≤–∏–¥—è—Ç –∫–ª–∏–µ–Ω—Ç—ã –≤ –∫–∞—Ä—Ç–æ—á–∫–µ –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞</div>
          </div>
          <div class="badge" id="badge-verified">
            <span class="badge-dot-warn" id="badge-verified-dot"></span>
            <span id="badge-verified-text">–û–∂–∏–¥–∞–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è</span>
          </div>
        </div>

        <div class="form-grid">
          <div class="field">
            <div class="label">–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏</div>
            <input id="fld-name" class="input" placeholder="–û–û–û ¬´–ö–æ–º–ø–∞–Ω–∏—è¬ª" />
          </div>
          <div class="field">
            <div class="label">–ì–æ—Ä–æ–¥</div>
            <input id="fld-city" class="input" placeholder="–ú–æ—Å–∫–≤–∞" />
          </div>
          <div class="field">
            <div class="label">–ö–∞—Ç–µ–≥–æ—Ä–∏—è —Ç–æ–≤–∞—Ä–∞</div>
            <input id="fld-category" class="input" placeholder="Vape, –∫–æ—Å–º–µ—Ç–∏–∫–∞, —Å–ø–æ—Ä—Ç–ø–∏—Ç..." />
          </div>
          <div class="field">
            <div class="label">–¢–µ–ª–µ—Ñ–æ–Ω</div>
            <input id="fld-phone" class="input" placeholder="+7..." />
          </div>
          <div class="field">
            <div class="label">Telegram –¥–ª—è —Å–≤—è–∑–∏</div>
            <input id="fld-telegram" class="input" placeholder="@username" />
          </div>
          <div class="field">
            <div class="label">–°–∞–π—Ç / —Å—Å—ã–ª–∫–∞</div>
            <input id="fld-site" class="input" placeholder="https://..." />
          </div>
          <div class="chips-row" id="chips-row">
            <div class="chip" id="chip-chz">–ß–ó / –≠–î–û: –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div>
            <div class="chip" id="chip-id">ID –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞: ‚Äî</div>
            <div class="chip" id="chip-ms">–ú–æ–π–°–∫–ª–∞–¥: –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω</div>
          </div>
        </div>

        <div class="btn-row">
          <button class="btn btn-soft" id="btn-cancel">–û—Ç–º–µ–Ω–∞</button>
          <button class="btn btn-primary" id="btn-save">
            üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å
          </button>
        </div>
        <div class="status-line" id="status-profile">
          <span class="status-dot-neutral"></span>
          <span>–ò–∑–º–µ–Ω–µ–Ω–∏—è –ø–æ–∫–∞ –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–ª–∏—Å—å.</span>
        </div>
<div class="btn-row" style="margin-top:10px; display:flex; gap:8px;">
  <a href="https://sonimz1307-pixel.github.io/optovizor-moysklad-instruction/company.html"
     target="_blank"
     class="btn btn-soft"
     style="flex:1; text-align:center; text-decoration:none;">üåê –°–∞–π—Ç OptoVizor</a>

  <a href="https://t.me/opto_placeholder"
     target="_blank"
     class="btn btn-soft"
     style="flex:1; text-align:center; text-decoration:none;">üí¨ Telegram‚Äë—Å–æ–æ–±—â–µ—Å—Ç–≤–æ</a>
</div>
      </section>

<!-- ===========================
     –ú–æ–π–°–∫–ª–∞–¥ ‚Äî –ù–û–í–ê–Ø –ò–ù–¢–ï–ì–†–ê–¶–ò–Ø
     =========================== -->

<div class="accordion" id="acc-ms">
  <div class="accordion-header">
    <span>–ú–æ–π–°–∫–ª–∞–¥ ‚Äî –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è (–Ω–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞)</span>
    <span class="acc-arrow">‚ñº</span>
  </div>

  <div class="accordion-body">
    <section class="card" id="card-ms">

      <div class="card-header">
        <div>
          <div class="card-title">–ü—Ä–∏–≤—è–∑–∫–∞ –∞–∫–∫–∞—É–Ω—Ç–∞ –ú–æ–π–°–∫–ª–∞–¥</div>
          <div class="card-sub">–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ç–æ–∫–µ–Ω –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è</div>
        </div>
        <div class="badge">
          <span id="ms-badge-dot" class="status-dot-neutral"></span>
          <span id="ms-badge-text">–ù–µ –ø—Ä–∏–≤—è–∑–∞–Ω</span>
        </div>
      </div>

      <!-- TOKEN FIELD -->
      <div class="form-grid">
        <div class="field">
          <div class="label">–í–∞—à —Ç–æ–∫–µ–Ω –¥–ª—è –ú–æ–π–°–∫–ª–∞–¥</div>
          <input id="ms-token" class="input" readonly placeholder="–¢–æ–∫–µ–Ω –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è..." />
        </div>

        <div class="btn-row">
          <button class="btn btn-soft" id="ms-copy">üìã –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–∫–µ–Ω</button>
        </div>
      </div>

      <div class="form-grid" style="margin-top:12px;">
        <div class="label">–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è</div>

        <div class="steps">
          <div class="steps-title">–ö–∞–∫ –ø–æ–¥–∫–ª—é—á–∏—Ç—å –ú–æ–π–°–∫–ª–∞–¥:</div>
          <ol>
            <li>–û—Ç–∫—Ä–æ–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ OptoVizor –≤ –ú–æ–π–°–∫–ª–∞–¥.</li>
            <li>–í–≤–µ–¥–∏—Ç–µ —Ç—É–¥–∞ —ç—Ç–æ—Ç —Ç–æ–∫–µ–Ω.</li>
            <li>–ù–∞–∂–º–∏—Ç–µ ¬´–ü—Ä–∏–≤—è–∑–∞—Ç—å¬ª –≤ –ú–æ–π–°–∫–ª–∞–¥.</li>
            <li>–ù–∞–∂–º–∏—Ç–µ ¬´–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–∏–≤—è–∑–∫—É¬ª –Ω–∏–∂–µ.</li>
          </ol>
        </div>
      </div>

      <div class="btn-row" style="margin-top:12px;">
        <button class="btn btn-primary" id="ms-check">
          üîç –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–∏–≤—è–∑–∫—É
        </button>
      </div>

      <a href="https://online.moysklad.ru/" target="_blank" class="link-btn" style="margin-top:12px;">
        üåê –û—Ç–∫—Ä—ã—Ç—å –ú–æ–π–°–∫–ª–∞–¥
      </a>

      <div class="status-line" id="ms-status">
        <span class="status-dot-neutral"></span>
        <span>–û–∂–∏–¥–∞–µ—Ç –ø—Ä–∏–≤—è–∑–∫–∏...</span>
      </div>

    </section>
  </div>
</div>


    </div>
  
<div class="accordion" id="acc-1c">
  <div class="accordion-header">
    <span>1–° ‚Äî –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è</span>
    <span class="acc-arrow">‚ñº</span>
  </div>
  <div class="accordion-body">
    <section class="card">
      <div class="card-header">
        <div>
          <div class="card-title">1–° ‚Äî –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è (—Å–∫–æ—Ä–æ)</div>
          <div class="card-sub">–í–µ–¥—ë—Ç—Å—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞ –æ–±–º–µ–Ω–∞ —Ç–æ–≤–∞—Ä–∞–º–∏ –∏ –æ—Å—Ç–∞—Ç–∫–∞–º–∏ —Å 1–°.</div>
        </div>
      </div>
      <div class="form-grid">
        <div class="field">
          <div class="label">–°—Ç–∞—Ç—É—Å</div>
          <div class="status-line">
            <span class="status-dot-neutral"></span>
            <span>–ú–æ–¥—É–ª—å –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ.</span>
          </div>
        </div>
      </div>
    </section>
  </div>
</div>
</div>

  <script>
    const tg = window.Telegram && window.Telegram.WebApp;
    if (tg) {
      // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –±–∞–≥–∞ Telegram WebApp —Å –ø—É—Å—Ç—ã–º —ç–∫—Ä–∞–Ω–æ–º
      setTimeout(() => {
        tg.ready();
        tg.expand();
      }, 200);
    }

    const fldName     = document.getElementById('fld-name');
    const fldCity     = document.getElementById('fld-city');
    const fldCategory = document.getElementById('fld-category');
    const fldPhone    = document.getElementById('fld-phone');
    const fldTelegram = document.getElementById('fld-telegram');
    const fldSite     = document.getElementById('fld-site');

    const chipChz  = document.getElementById('chip-chz');
    const chipId   = document.getElementById('chip-id');
    const chipMs   = document.getElementById('chip-ms');
    const subtitle = document.getElementById('subtitle');

    const badgeVerifiedDot  = document.getElementById('badge-verified-dot');
    const badgeVerifiedText = document.getElementById('badge-verified-text');

    const statusProfile = document.getElementById('status-profile');

    const btnSave   = document.getElementById('btn-save');
    const btnCancel = document.getElementById('btn-cancel');

    const btnConnectMoy = document.getElementById('btn-connect-moy');
    const statusMoyDot  = document.getElementById('status-moy-dot');
    const statusMoyText = document.getElementById('status-moy-text');

    const storeSelect   = document.getElementById('store-select');
    const btnSaveStore  = document.getElementById('btn-save-store');

    let originalProfile = null;

    function loadProfileFromQuery() {
      try {
        const url = new URL(window.location.href);
        const dataStr = url.searchParams.get('data');
        if (!dataStr) {
          subtitle.textContent = '–î–∞–Ω–Ω—ã–µ –ø—Ä–æ—Ñ–∏–ª—è –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω—ã. –û—Ç–∫—Ä–æ–π—Ç–µ –ø—Ä–æ—Ñ–∏–ª—å –∏–∑ –±–æ—Ç–∞.';
          return;
        }

        const decoded = decodeURIComponent(dataStr);
        const obj = JSON.parse(decoded);
        originalProfile = obj;
        window.profileData = obj;

        fldName.value     = obj.name || '';
        fldCity.value     = obj.city || '';
        fldCategory.value = obj.category || '';
        fldPhone.value    = obj.phone || '';
        fldTelegram.value = obj.telegram || '';
        fldSite.value     = obj.site || '';

        const chz = !!obj.is_chz;
        chipChz.textContent = '–ß–ó / –≠–î–û: ' + (chz ? '–î–∞' : '–ù–µ—Ç');
        chipChz.style.borderStyle = chz ? 'solid' : 'dashed';

        const idVal = obj.id != null ? String(obj.id) : '‚Äî';
        chipId.textContent = 'ID –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞: ' + idVal;

        const verified = !!obj.is_verified;
        if (verified) {
          badgeVerifiedText.textContent = '–ü–æ—Å—Ç–∞–≤—â–∏–∫ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω';
          badgeVerifiedDot.classList.remove('badge-dot-warn');
          badgeVerifiedDot.classList.add('badge-dot-ok');
        } else {
          badgeVerifiedText.textContent = '–û–∂–∏–¥–∞–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è';
          badgeVerifiedDot.classList.remove('badge-dot-ok');
          badgeVerifiedDot.classList.add('badge-dot-warn');
        }

        const moyLinked   = !!obj.moy_linked;
        const moyAccount  = obj.moy_account_id || null;

        if (moyLinked) {
          chipMs.textContent = '–ú–æ–π–°–∫–ª–∞–¥: –ø–æ–¥–∫–ª—é—á–µ–Ω';
          chipMs.style.borderStyle = 'solid';
          statusMoyDot.className = '';
          statusMoyDot.classList.add('status-dot-ok');
          statusMoyText.textContent = moyAccount
            ? `–ú–æ–π–°–∫–ª–∞–¥ –ø—Ä–∏–≤—è–∑–∞–Ω (account_id –∑–∞–∫–∞–Ω—á–∏–≤–∞–µ—Ç—Å—è –Ω–∞ ...${String(moyAccount).slice(-6)})`
            : '–ú–æ–π–°–∫–ª–∞–¥ –ø—Ä–∏–≤—è–∑–∞–Ω –∫ –≤–∞—à–µ–º—É Telegram.';
          btnConnectMoy.textContent = 'üîÑ –ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∏—Ç—å –ú–æ–π–°–∫–ª–∞–¥';
        } else {
          chipMs.textContent = '–ú–æ–π–°–∫–ª–∞–¥: –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω';
          chipMs.style.borderStyle = 'dashed';
          statusMoyDot.className = '';
          statusMoyDot.classList.add('status-dot-neutral');
          statusMoyText.textContent = '–ú–æ–π–°–∫–ª–∞–¥ –µ—â—ë –Ω–µ –ø—Ä–∏–≤—è–∑–∞–Ω –∫ –≤–∞—à–µ–º—É Telegram.';
          btnConnectMoy.textContent = 'üîó –ü–æ–¥–∫–ª—é—á–∏—Ç—å –ú–æ–π–°–∫–ª–∞–¥';
        }

        subtitle.textContent = `ID: ${idVal === '‚Äî' ? '–Ω–µ –Ω–∞–∑–Ω–∞—á–µ–Ω' : idVal}`;

        fillStoreList();

      } catch (e) {
        console.error('parse profile error', e);
        subtitle.textContent = '–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –ø—Ä–æ—Ñ–∏–ª—è.';
      }
    }

    loadProfileFromQuery();

    function fillStoreList() {
      if (!storeSelect) return;

      const data = window.profileData || {};
      const stores = Array.isArray(data.stores) ? data.stores : [];
      const defaultStoreId = data.default_store_id || null;

      // –æ—á–∏—Å—Ç–∏—Ç—å, –æ—Å—Ç–∞–≤–∏—Ç—å —Ç–æ–ª—å–∫–æ "–í—Å–µ —Å–∫–ª–∞–¥—ã"
      while (storeSelect.options.length > 1) {
        storeSelect.remove(1);
      }

      stores.forEach((s) => {
        if (!s || !s.id || !s.name) return;
        const opt = document.createElement('option');
        opt.value = s.id;
        opt.textContent = s.name;
        storeSelect.appendChild(opt);
      });

      if (defaultStoreId) {
        storeSelect.value = defaultStoreId;
      } else {
        storeSelect.value = 'all';
      }
    }

    function setProfileStatus(type, text) {
      let dot = statusProfile.querySelector('span');
      let msg = statusProfile.querySelectorAll('span')[1];

      dot.className = '';
      if (type === 'loading') {
        dot.classList.add('status-dot-loading');
      } else if (type === 'ok') {
        dot.classList.add('status-dot-ok');
      } else {
        dot.classList.add('status-dot-neutral');
      }

      msg.textContent = text;
    }

    btnSave.addEventListener('click', () => {
      if (!tg) {
        alert('–û—Ç–∫—Ä–æ–π—Ç–µ —ç—Ç–æ—Ç —ç–∫—Ä–∞–Ω –∏–∑ Telegram-–±–æ—Ç–∞.');
        return;
      }

      const payload = {
        action: 'save_supplier_profile',
        name: fldName.value.trim(),
        city: fldCity.value.trim(),
        category: fldCategory.value.trim(),
        phone: fldPhone.value.trim(),
        telegram: fldTelegram.value.trim(),
        site: fldSite.value.trim()
      };

      setProfileStatus('loading', '–û—Ç–ø—Ä–∞–≤–ª—è—é –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –±–æ—Ç–∞...');

      try {
        tg.sendData(JSON.stringify(payload));
        setTimeout(() => {
          setProfileStatus('ok', '–ò–∑–º–µ–Ω–µ–Ω–∏—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –±–æ—Ç–∞ –≤ Telegram.');
        }, 600);
      } catch (e) {
        console.error(e);
        setProfileStatus('error', '–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –¥–∞–Ω–Ω—ã—Ö. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.');
      }
    });

    btnCancel.addEventListener('click', () => {
      if (originalProfile) {
        fldName.value     = originalProfile.name || '';
        fldCity.value     = originalProfile.city || '';
        fldCategory.value = originalProfile.category || '';
        fldPhone.value    = originalProfile.phone || '';
        fldTelegram.value = originalProfile.telegram || '';
        fldSite.value     = originalProfile.site || '';
      }
      setProfileStatus('neutral', '–ò–∑–º–µ–Ω–µ–Ω–∏—è —Å–±—Ä–æ—à–µ–Ω—ã, –ø—Ä–æ—Ñ–∏–ª—å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω.');
    });


    if (btnSaveStore && storeSelect) {
      btnSaveStore.addEventListener('click', () => {
        if (!tg) {
          alert('–û—Ç–∫—Ä–æ–π—Ç–µ —ç—Ç–æ—Ç —ç–∫—Ä–∞–Ω –∏–∑ Telegram-–±–æ—Ç–∞.');
          return;
        }

        const storeId = storeSelect.value || 'all';

        try {
          tg.sendData(JSON.stringify({
            action: 'set_moysklad_store',
            store_id: storeId
          }));
          alert('–í—ã–±–æ—Ä —Å–∫–ª–∞–¥–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤ –±–æ—Ç. –û—Ç–∫—Ä–æ–π—Ç–µ —á–∞—Ç –∏ –¥–æ–∂–¥–∏—Ç–µ—Å—å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è.');
        } catch (e) {
          console.error(e);
          alert('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –≤—ã–±–æ—Ä —Å–∫–ª–∞–¥–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.');
        }
      });
    }


    /* üî• –ù–û–í–´–ô –û–ë–†–ê–ë–û–¢–ß–ò–ö –ú–û–ô–°–ö–õ–ê–î ‚Äî –¢–í–û–Ø –ü–†–û–°–¨–ë–ê */
    let connecting = false;

    function setMoyStatus(type, text) {
      statusMoyDot.className = '';
      if (type === 'loading') {
        statusMoyDot.classList.add('status-dot-loading');
      } else if (type === 'ok') {
        statusMoyDot.classList.add('status-dot-ok');
      } else if (type === 'error') {
        statusMoyDot.classList.add('badge-dot-warn');
      } else {
        statusMoyDot.classList.add('status-dot-neutral');
      }
      statusMoyText.textContent = text;
    }

    btnConnectMoy.addEventListener('click', () => {
      if (!tg) {
        alert('–û—Ç–∫—Ä–æ–π—Ç–µ —ç—Ç–æ—Ç —ç–∫—Ä–∞–Ω –∏–∑ Telegram-–±–æ—Ç–∞.');
        return;
      }
      if (connecting) return;

      connecting = true;
      btnConnectMoy.disabled = true;

      setMoyStatus('loading', '–û—Ç–ø—Ä–∞–≤–ª—è—é –∑–∞–ø—Ä–æ—Å –Ω–∞ –ø—Ä–∏–≤—è–∑–∫—É –ú–æ–π–°–∫–ª–∞–¥ –∫ –≤–∞—à–µ–º—É Telegram...');

      try {
        tg.sendData(JSON.stringify({
          action: 'connect_moysklad',
          moy_account_id: window.profileData?.moy_account_id || null
        }));
      } catch (e) {
        console.error(e);
        setMoyStatus('error', '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–ø—Ä–æ—Å. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.');
        btnConnectMoy.disabled = false;
        connecting = false;
        return;
      }

      setTimeout(() => {
        setMoyStatus(
          'ok',
          '–ó–∞–ø—Ä–æ—Å –Ω–∞ –ø—Ä–∏–≤—è–∑–∫—É –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω ‚úÖ\n–û—Ç–∫—Ä–æ–π—Ç–µ —á–∞—Ç —Å –±–æ—Ç–æ–º ‚Äî —Ç–∞–º –±—É–¥–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ.'
        );
      }, 700);

      setTimeout(() => {
        connecting = false;
        btnConnectMoy.disabled = false;
      }, 2000);
    });

  
// ACCORDION
document.querySelectorAll('.accordion-header').forEach(h=>{
  h.addEventListener('click',()=>h.parentElement.classList.toggle('open'));
});

</script>
</body>
</html>
